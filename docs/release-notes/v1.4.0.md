# v1.4.0 发行说明

## 🎉 概述

v1.4.0 是一个重要的功能版本，包含了多项用户体验提升、稳定性增强和架构优化。本版本新增了传统分页模式、HTTP 自动重试、账户批量操作等功能，同时对后端进行了全面的架构重构。

**发布日期**: 2024-12-15

---

## ✨ 新增功能

### 1. DNS 记录列表分页模式选择

用户现在可以在设置中选择喜欢的分页方式：

- **无限滚动模式**（默认）：滚动到底部自动加载更多，适合移动端
- **传统分页模式**：使用分页器快速跳转页码，适合桌面端

**特性**：
- 支持自定义每页显示数量（10/20/50/100 条）
- 智能页码显示（页数多时自动显示省略号）
- 设置实时生效并持久化保存

### 2. HTTP 请求自动重试机制

为所有 DNS Provider 的网络请求添加了自动重试功能：

- **默认重试 2 次**：网络故障时自动重试，提升稳定性
- **指数退避策略**：100ms → 200ms → 400ms → ... (最大 10 秒)
- **智能重试判断**：只重试网络错误，业务错误（如认证失败）不重试
- **可配置**：支持通过 Builder 模式自定义重试次数

### 3. Provider 分页限制透明化

后端 API 现在会返回各 Provider 的分页限制信息：

| Provider | 域名列表 | DNS 记录 |
|----------|---------|---------|
| Cloudflare | 50/页 | 5000/页 |
| 阿里云 | 100/页 | 100/页 |
| DNSPod | 3000/页 | 3000/页 |
| 华为云 | 500/页 | 500/页 |

- 前端自动适配各 Provider 的 API 限制
- 避免发送超过限制的请求
- 用户选择的每页数量会自动限制在 API 允许范围内

### 4. 账户批量操作

账户管理页面新增批量删除功能：

- 批量选择账户
- 一键删除多个账户
- 显示删除结果（成功/失败统计）

### 5. 账户信息更新

支持更新现有账户的信息：

- 修改账户名称
- 更新账户凭证
- 自动重新验证凭证有效性

---

## 🔧 架构优化

### 1. HTTP Client 统一重构

**改进**：
- 提取通用 `HttpUtils` 工具类
- 消除各 Provider 间的 HTTP 处理重复代码
- 统一日志记录和错误处理流程
- 保持各 Provider 签名算法的完全独立性

**收益**：
- 代码减少 23 行
- 更易维护和扩展

### 2. Provider 元数据自包含

**改进**：
- 在 `DnsProvider` trait 中添加 `metadata()` 关联函数
- 各 Provider 自己提供元数据（名称、描述、凭证字段、功能特性、分页限制）
- 元数据与实现代码在同一文件中

**收益**：
- factory.rs 代码减少 83 行（-57.6%）
- 添加新 Provider 时只需在一处定义元数据
- 不会出现元数据与实现不一致的情况

### 3. Provider Builder 模式

**改进**：
- 为所有 4 个 DNS Provider 添加 Builder 模式
- 支持配置重试次数、超时等参数
- 保持向后兼容（`new()` 方法仍然可用）

**示例**：
```rust
let provider = CloudflareProvider::builder(api_token)
    .max_retries(3)
    .build();
```

**收益**：
- 更灵活的配置选项
- 提升可测试性（可注入 mock client）
- 为未来扩展打下基础

### 4. 账户服务层重构

**改进**：
- 拆分 `AccountService` 为 4 个专门的服务：
  - `AccountLifecycleService` - 账户生命周期管理（CRUD）
  - `AccountMetadataService` - 元数据持久化
  - `CredentialManagementService` - 凭证管理和 Provider 注册
  - `AccountBootstrapService` - 启动时账户恢复
- 职责更加单一清晰
- 更好的代码组织

### 5. 加密模块重构

**改进**：
- 提取加密版本管理为独立模块
- 支持多版本加密算法共存
- 当前使用 PBKDF2-HMAC-SHA256 (600,000 次迭代，符合 OWASP 2023 推荐)

---

## 🐛 Bug 修复

### 样式修复

- 为发布说明添加文本换行支持，避免长文本溢出

---

## 📊 技术统计

- **修改文件**: 69 个
- **新增代码**: +2723 行
- **删除代码**: -870 行
- **净增加**: +1853 行

**主要变更分布**：
- Provider 层重构: ~800 行
- 服务层重构: ~600 行
- 前端分页功能: ~400 行
- 账户管理增强: ~300 行

---

## 🔄 破坏性变更

**无破坏性变更** - 本版本保持完全向后兼容：

- ✅ Provider API 保持不变
- ✅ 数据库结构无变化
- ✅ 存储格式兼容
- ✅ 所有现有功能正常工作

---

## 📝 升级说明

### 从 v1.3.2 升级

直接安装新版本即可，无需任何额外操作：

1. 下载并安装 v1.4.0
2. 应用会自动迁移数据（如需要）
3. 可选：进入设置页面体验新的分页模式

### 推荐配置

- 如果主要使用移动端，保持默认的"无限滚动"模式
- 如果主要使用桌面端且记录较多，可切换到"传统分页"模式
- 可根据习惯调整每页显示数量（10/20/50/100）

---

## 🙏 致谢

感谢所有用户的反馈和建议，帮助我们不断改进 DNS Orchestrator。

---

## 📚 相关资源

- [GitHub 仓库](https://github.com/AptS-1547/dns-orchestrator)
- [问题反馈](https://github.com/AptS-1547/dns-orchestrator/issues)
- [完整更新日志](https://github.com/AptS-1547/dns-orchestrator/blob/master/CHANGELOG.md)
